<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staffelzins</title>
</head>
<body>
<div><h1>Zinsrechnung</h1></div>
<div>
    <label for="startkapital">Startkapital:</label>
    <input type="number" id="startkapital" name="startkapital" oninput="calcCapital()" value="1000"/>
</div>

<div>
    <label for="tage">Tage:</label>
    <input type="number" id="tage" name="tage" oninput="calcCapital()" value="200"/>
</div>

<div>
    <label for="zins">Zins in Prozent:</label>
    <input type="number" id="zins" name="zins" oninput="calcCapital()" value="1"/>
</div>

<div>
    <label for="aktie_preis">Preis Aktie:</label>
    <input type="number" id="aktie_preis" name="aktie_preis" oninput="calcCapital()" value="25"/>
</div>

<div>
    <button onclick="calcCapital()">Vermögen Kalkulieren</button>
    <span id="vermoegen"></span>
</div>

<canvas id="myChart" style="width: 90vw; height: 60vh"></canvas>

<hr>

<div><h1>Tagebuch</h1></div>
<div id="diary"></div>


</body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('myChart');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {label: 'Vermögensentwicklung (Gestückelt)', data: [], borderWidth: 1},
                {label: 'Vermögensentwicklung (Normal)', data: [], borderWidth: 1},
            ],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false
                }
            },
            interaction: {
                intersect: true,
                mode: 'index',
            },
        }
    });

    const labels = [0];
    const data_staffel = [];
    const data_normal = [];

    function calcCapital() {
        console.log('recalculation');
        labels.length = 0;
        data_staffel.length = 0;
        data_normal.length = 0;
        let kapital = parseFloat(document.getElementById('startkapital').value);
        data_staffel.push(kapital);
        data_normal.push(kapital);
        const tage = parseInt(document.getElementById('tage').value);
        const zins = parseFloat(document.getElementById('zins').value);
        const aktie_preis = parseFloat(document.getElementById('aktie_preis').value);

        let kapital_staffel = kapital;
        let kapital_normal = kapital;
        let zwischenkapital = 0;
        for (let i = 0; i < tage; ++i) {
            //staffel
            labels.push(i + 1);
            const profit_tag = kapital_staffel * zins / 100;
            zwischenkapital += profit_tag;
            const kaufbare_aktien = Math.floor(zwischenkapital / aktie_preis);
            if (kaufbare_aktien > 0) {
                kapital_staffel += kaufbare_aktien * aktie_preis;
                zwischenkapital -= kaufbare_aktien * aktie_preis;
            }
            data_staffel.push(kapital_staffel);

            //normal
            kapital_normal *= 1 + zins / 100;
            data_normal.push(kapital_normal);
        }

        myChart.data.labels = labels;
        myChart.data.datasets[0].data = data_staffel;
        myChart.data.datasets[1].data = data_normal;
        myChart.update();

        const end_kapital = kapital_staffel + zwischenkapital;
        if (!isNaN(end_kapital)) {
            document.getElementById('vermoegen').innerHTML = `Endkapital: ${(end_kapital).toFixed(2)}`;
        } else {
            document.getElementById('vermoegen').innerHTML = 'Fehler';
        }
    }

    (async () => {
        const response = await fetch(
            'https://raw.githubusercontent.com/boost3000/trading-sashboard/master/diary.csv',
            {cache: 'no-store'}
        );
        const data = await response.text();
        console.log({data});
        let html = '<table>';
        for (const [i, row] of data.split('\n').filter(row => row).entries()) {
            let row_html = '<tr>';
            for (const col of row.split(',')) {
                if (i === 0) {
                    row_html += `<th>${col}</th>`;
                } else {
                    row_html += `<td>${col}</td>`;
                }
            }
            row_html += '</tr>';
            html += row_html;
        }

        html += '</table>';
        const table = document.getElementById('diary');
        table.innerHTML = html;
    })();


    calcCapital();
</script>

<style>
    div {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        max-width: 400px;
    }

    label {
        flex: 1;
    }

    input {
        flex: 1;
        text-align: right; /* Optional: text inside the input is right-aligned */
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }
    td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
</style>
</html>
